{% extends 'solicitudesF/base.html' %}
{% load static %}

{% block title %}Solicitudes Disponibles{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-6 fw-bold">Solicitudes Ciudadanas</h1>
            <h2 class="h4 text-muted">Municipalidad de Fresia</h2>
            <p class="lead">
                En el cuadro inferior de esta página encontrará el listado de servicios que el Municipio coloca a su disposición.
                Para cada servicio se indica el Área y la Dirección al cual está asociado, para orientar mejor su ejecución.
            </p>
            <p><strong>Paso 1:</strong> Debe buscar el que más se ajuste a su necesidad.</p>
            <p><strong>Paso 2:</strong> Presionar el botón "Realizar Solicitud".</p>
            <p><strong>Paso 3:</strong> Completar el formulario correspondiente.</p>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5 class="card-title text-center">Solicitudes Realizadas</h5>
                <p class="card-text text-center text-muted">
                    Para revisar el estado de las solicitudes realizadas, haga clic en el siguiente botón.
                </p>
                <div class="d-grid">
                    <a href="#" class="btn btn-primary">Revisar Solicitudes</a>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <div class="card shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Solicitudes disponibles por Dirección</h4>
            <div class="input-group" style="max-width: 300px;">
                <input type="text" class="form-control" placeholder="Buscar Solicitud" aria-label="Buscar Solicitud" id="search-input">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
        </div>
        <p class="text-muted">
            Seleccione la solicitud que mejor se ajuste a su requerimiento y presione el botón "Realizar Solicitud".
            Puede utilizar el buscador de la derecha, indicando algún concepto o palabra clave de la solicitud a realizar.
        </p>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="solicitudes-table">
                <thead>
                    <tr>
                        <th scope="col">Nº</th>
                        <th scope="col">SOLICITUD CIUDADANA</th>
                        <th scope="col">DIRECCIÓN</th>
                        <th scope="col">DESCRIPCIÓN</th>
                        <th scope="col">OPCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tipo in tipos_solicitud %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td>{{ tipo.nombre }}</td>
                        <td>{{ tipo.direccion }}</td>
                        <td>{{ tipo.descripcion_corta }}</td>
                        <td>
                            <button class="btn btn-success btn-sm"
                                    data-url="{% url 'solicitudesF:crear_solicitud' %}?tipo_id={{ tipo.id }}"
                                    onclick="abrirModal(this)">
                                Realizar Solicitud
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No hay tipos de solicitudes disponibles.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="modal-content">
      <!-- Aquí se inyectará el formulario -->
    </div>
  </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ajuste navbar para mostrar usuario
        const navbarNav = document.getElementById('navbarNav');
        if (navbarNav) {
            const userNavItem = document.createElement('li');
            userNavItem.className = 'nav-item d-flex align-items-center ms-auto';
            userNavItem.innerHTML = `
                <span class="navbar-text me-2 text-white">
                    <strong class="text-info">{{ nombre_usuario }}</strong>
                </span>
                <a class="nav-link text-white" href="#"><i class="bi bi-box-arrow-right"></i></a>
            `;
            navbarNav.appendChild(userNavItem);
        }

        // Filtro de búsqueda en tabla
        const searchInput = document.getElementById('search-input');
        const table = document.getElementById('solicitudes-table');
        const rows = table.getElementsByTagName('tr');

        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filter = searchInput.value.toLowerCase();
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let rowText = '';
                    for (let j = 0; j < cells.length - 1; j++) {
                        rowText += cells[j].textContent || cells[j].innerText;
                    }
                    rows[i].style.display = rowText.toLowerCase().includes(filter) ? '' : 'none';
                }
            });
        }
    });

    // Función para abrir modal con el formulario
    function abrirModal(btn){
        let url = btn.getAttribute("data-url");

        fetch(url)
        .then(response => response.text())
        .then(html => {
            document.getElementById("modal-content").innerHTML = html;
            let myModal = new bootstrap.Modal(document.getElementById("modalSolicitud"));
            myModal.show();
        })
        .catch(error => console.error('Error cargando el formulario:', error));
    }
</script>
{% endblock %}
{% endblock %}
